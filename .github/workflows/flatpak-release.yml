name: Build & publish Flatpak

on:
  push:
    tags:
      - 'v*'

jobs:
  build-flatpak:
    name: Build Flatpak and upload release asset
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends flatpak flatpak-builder jq

      - name: Ensure Flathub remote exists (user-level)
        run: |
          # Use the user-level remote to avoid requiring system permissions on the runner
          if ! flatpak --user remote-list 2>/dev/null | grep -q flathub; then
            flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          fi

      - name: Set up build directories
        run: |
          rm -rf build-dir repo
          mkdir -p build-dir repo

      - name: Build Flatpak repository
        run: |
          flatpak-builder --repo=repo --force-clean build-dir com.github.th3cavalry.linux-armoury.yml

      - name: Create Flatpak bundle
        id: create_bundle
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BUNDLE=linux-armoury-${TAG_NAME}.flatpak
          flatpak build-bundle repo "$BUNDLE" com.github.th3cavalry.linux-armoury --force
          echo "bundle=$BUNDLE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            Release ${{ github.ref_name }} - Flatpak build generated by GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Flatpak to GitHub Release
        if: success() && steps.create_bundle.outputs.bundle != ''
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.create_bundle.outputs.bundle }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Fallback: if the built artifact is not available, attach the repo-provided
      # pre-built flatpak as an asset to the release so the tag has a usable artifact.
      - name: Upload repo-provided Flatpak (fallback)
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          files: linux-armoury-0.5.0b0.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
