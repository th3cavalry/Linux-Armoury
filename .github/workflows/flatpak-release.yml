name: Build & publish Flatpak

on:
  push:
    tags:
      - 'v*'

jobs:
  build-flatpak:
    name: Build Flatpak and upload release asset
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends flatpak flatpak-builder jq

      - name: Ensure Flathub remote exists (user-level)
        run: |
          # Use the user-level remote to avoid requiring system permissions on the runner
          if ! flatpak --user remote-list 2>/dev/null | grep -q flathub; then
            flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          fi

      - name: Set up build directories
        run: |
          rm -rf build-dir repo
          mkdir -p build-dir repo

      - name: Build Flatpak repository
        continue-on-error: true
        run: |
          flatpak-builder --repo=repo --force-clean build-dir com.github.th3cavalry.linux-armoury.yml

      - name: Create Flatpak bundle
        if: always()
        id: create_bundle
        continue-on-error: true
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BUNDLE=linux-armoury-${TAG_NAME}.flatpak

          if [ ! -d repo ]; then
            echo "ERROR: repo directory not found"
            exit 1
          fi

          # Debug: Check repo structure
          echo "=== Repo structure ==="
          ls -la repo/ | head -20
          echo "=== Flatpak refs in repo ==="
          flatpak refs --repo=repo || echo "No refs found"

          # Attempt to create bundle
          echo "=== Attempting to create bundle: $BUNDLE ==="
          if flatpak build-bundle \
              --repo=repo \
              --force \
              "$BUNDLE" \
              com.github.th3cavalry.linux-armoury 2>&1; then
            echo "✓ Bundle created successfully"
            if [ -f "$BUNDLE" ]; then
              echo "output_file=$BUNDLE" >> $GITHUB_OUTPUT
              ls -lh "$BUNDLE"
            fi
          else
            echo "✗ Bundle creation failed, will use fallback"
          fi

          echo "=== All .flatpak files in workspace ==="
          find . -maxdepth 1 -name "*.flatpak" -type f

      - name: Prepare Flatpak asset for release
        if: always()
        id: prepare_asset
        continue-on-error: true
        run: |
          # Check for built bundle
          BUILT_BUNDLE="${{ steps.create_bundle.outputs.output_file }}"
          FALLBACK_FILE="linux-armoury-0.5.0b0.flatpak"

          echo "DEBUG: BUILT_BUNDLE=$BUILT_BUNDLE"
          echo "DEBUG: FALLBACK_FILE=$FALLBACK_FILE"
          echo "DEBUG: Files in workspace:"
          ls -lh *.flatpak 2>/dev/null || echo "No .flatpak files found"

          if [ -n "$BUILT_BUNDLE" ] && [ -f "$BUILT_BUNDLE" ]; then
            echo "asset=$BUILT_BUNDLE" >> $GITHUB_OUTPUT
            echo "✓ Using built bundle: $BUILT_BUNDLE"
          elif [ -f "$FALLBACK_FILE" ]; then
            echo "asset=$FALLBACK_FILE" >> $GITHUB_OUTPUT
            echo "✓ Using fallback: $FALLBACK_FILE"
          else
            echo "ERROR: No flatpak file available"
            echo "asset=" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release and Upload Asset
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
        run: |
          set -uo pipefail

          TAG_NAME=${GITHUB_REF#refs/tags/}
          ASSET_FILE="${{ steps.prepare_asset.outputs.asset }}"

          echo "DEBUG: TAG_NAME=$TAG_NAME"
          echo "DEBUG: ASSET_FILE=$ASSET_FILE"
          echo "DEBUG: Files in workspace:"
          ls -lh *.flatpak 2>/dev/null || echo "No .flatpak files"

          if [ -z "$ASSET_FILE" ]; then
            echo "ERROR: No asset file specified"
            exit 1
          fi

          if [ ! -f "$ASSET_FILE" ]; then
            echo "ERROR: Asset file not found: $ASSET_FILE"
            exit 1
          fi

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"

          # Check if release exists
          echo "Checking for existing release..."
          release=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" "$API_URL/releases/tags/$TAG_NAME")
          http_code=$(echo "$release" | tail -1)
          release_data=$(echo "$release" | head -n-1)
          echo "HTTP Code: $http_code"
          echo "Response: $release_data"

          release_id=""
          if [ "$http_code" = "200" ]; then
            release_id=$(echo "$release_data" | jq -r '.id' 2>/dev/null)
            echo "Release already exists: $release_id"
          else
            # Create release
            echo "Creating new release..."
            create_response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"$TAG_NAME\",\"body\":\"Release $TAG_NAME - Flatpak build generated by GitHub Actions\",\"prerelease\":true}" \
              "$API_URL/releases")
            create_http_code=$(echo "$create_response" | tail -1)
            create_data=$(echo "$create_response" | head -n-1)
            echo "Create HTTP Code: $create_http_code"
            echo "Create Response: $create_data"

            if [ "$create_http_code" = "201" ]; then
              release_id=$(echo "$create_data" | jq -r '.id' 2>/dev/null)
              echo "Created release: $release_id"
            else
              echo "ERROR: Failed to create release"
              exit 1
            fi
          fi

          if [ -z "$release_id" ]; then
            echo "ERROR: release_id is empty"
            exit 1
          fi

          # Upload asset
          ASSET_NAME=$(basename "$ASSET_FILE")
          echo "Uploading asset: $ASSET_NAME from $ASSET_FILE"
          upload_response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$ASSET_FILE" \
            "$API_URL/releases/$release_id/assets?name=$ASSET_NAME")
          upload_http_code=$(echo "$upload_response" | tail -1)
          upload_data=$(echo "$upload_response" | head -n-1)
          echo "Upload HTTP Code: $upload_http_code"
          echo "Upload response: $upload_data"

          if [ "$upload_http_code" = "201" ]; then
            echo "✓ Asset uploaded successfully"
          else
            echo "ERROR: Asset upload failed"
            exit 1
          fi
