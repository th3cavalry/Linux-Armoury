name: Build & publish Flatpak

on:
  push:
    tags:
      - 'v*'

jobs:
  build-flatpak:
    name: Build Flatpak and upload release asset
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends flatpak flatpak-builder jq

      - name: Ensure Flathub remote exists (user-level)
        run: |
          # Use the user-level remote to avoid requiring system permissions on the runner
          if ! flatpak --user remote-list 2>/dev/null | grep -q flathub; then
            flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          fi

      - name: Set up build directories
        run: |
          rm -rf build-dir repo
          mkdir -p build-dir repo

      - name: Build Flatpak repository
        continue-on-error: true
        run: |
          flatpak-builder --repo=repo --force-clean build-dir com.github.th3cavalry.linux-armoury.yml

      - name: Create Flatpak bundle
        if: always()
        id: create_bundle
        continue-on-error: true
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BUNDLE=linux-armoury-${TAG_NAME}.flatpak

          if [ ! -d repo ]; then
            echo "ERROR: repo directory not found"
            echo "bundle=" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Debug: Check repo structure
          echo "=== Repo structure ==="
          ls -la repo/ | head -20
          echo "=== Flatpak refs in repo ==="
          flatpak refs --repo=repo || echo "No refs found"

          # Attempt to create bundle
          echo "=== Attempting to create bundle: $BUNDLE ==="
          if flatpak build-bundle \
              --repo=repo \
              --force \
              "$BUNDLE" \
              com.github.th3cavalry.linux-armoury 2>&1; then
            echo "✓ Bundle created successfully"
            echo "bundle=$BUNDLE" >> $GITHUB_OUTPUT
          else
            echo "✗ Bundle creation failed, will use fallback"
            echo "bundle=" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release (best-effort)
        if: always()
        id: create_release
        continue-on-error: true
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            Release ${{ github.ref_name }} - Flatpak build generated by GitHub Actions
        env:
          # Prefer user-provided RELEASE_PAT (repo secret). Fallback to the workflow token.
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}

      - name: Ensure release exists and get upload URL
        id: release_info
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
        run: |
          set -euo pipefail
          TAG_NAME=${GITHUB_REF#refs/tags/}
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"
          # Try fetching release by tag
          resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/releases/tags/$TAG_NAME")
          release_id=$(echo "$resp" | jq -r '.id // empty') || true
          upload_url=$(echo "$resp" | jq -r '.upload_url // empty' | sed -e 's/{?name,label}//') || true
          if [ -z "${release_id:-}" ]; then
            echo "Release not found by tag, creating..."
            resp=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"$TAG_NAME\",\"prerelease\":true}" "$API_URL/releases")
            release_id=$(echo "$resp" | jq -r '.id')
            upload_url=$(echo "$resp" | jq -r '.upload_url' | sed -e 's/{?name,label}//')
          fi
          echo "release_id=$release_id" >> "$GITHUB_OUTPUT"
          echo "upload_url=$upload_url" >> "$GITHUB_OUTPUT"

      - name: Upload built Flatpak (or fallback) to Release
        if: always()
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
        run: |
          BUNDLE_PATH="${{ steps.create_bundle.outputs.bundle }}"
          FALLBACK_FILE="linux-armoury-0.5.0b0.flatpak"
          RELEASE_ID="${{ steps.release_info.outputs.release_id }}"
          UPLOAD_URL="${{ steps.release_info.outputs.upload_url }}"

          # Determine which file to upload
          if [ -n "$BUNDLE_PATH" ] && [ -f "$BUNDLE_PATH" ]; then
            file_to_upload="$BUNDLE_PATH"
            echo "Using built bundle: $file_to_upload"
          elif [ -f "$FALLBACK_FILE" ]; then
            file_to_upload="$FALLBACK_FILE"
            echo "Using fallback: $file_to_upload"
          else
            echo "ERROR: No flatpak file available to upload"
            exit 1
          fi

          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "ERROR: No upload URL available"
            exit 1
          fi

          echo "Uploading to: $UPLOAD_URL"
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$file_to_upload" \
            "$UPLOAD_URL?name=$(basename "$file_to_upload")" | jq -r '.browser_download_url // .id'

      # Fallback: if the built artifact is not available, attach the repo-provided
      # pre-built flatpak as an asset to the release so the tag has a usable artifact.
      - name: Upload repo-provided Flatpak (fallback)
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          files: linux-armoury-0.5.0b0.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
