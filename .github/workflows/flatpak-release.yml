name: Build & publish Flatpak

on:
  push:
    tags:
      - 'v*'

jobs:
  build-flatpak:
    name: Build Flatpak and upload release asset
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends flatpak flatpak-builder jq

      - name: Ensure Flathub remote exists (user-level)
        run: |
          # Use the user-level remote to avoid requiring system permissions on the runner
          if ! flatpak --user remote-list 2>/dev/null | grep -q flathub; then
            flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          fi

      - name: Set up build directories
        run: |
          rm -rf build-dir repo
          mkdir -p build-dir repo

      - name: Build Flatpak repository
        continue-on-error: true
        run: |
          flatpak-builder --repo=repo --force-clean build-dir com.github.th3cavalry.linux-armoury.yml

      - name: Create Flatpak bundle (verbose)
        if: always()
        id: create_bundle
        continue-on-error: true
        run: |
          set -euo pipefail
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BUNDLE=linux-armoury-${TAG_NAME}.flatpak
          echo "Bundle target: $BUNDLE"
          if [ -d repo ]; then
            echo "--- repo contents ---"
            ls -la repo || true
            echo "--- refs ---"
            flatpak refs --repo=repo || true
            echo "--- attempting build-bundle (verbose output) ---"
            flatpak build-bundle repo "$BUNDLE" com.github.th3cavalry.linux-armoury --force 2>&1 | tee /tmp/bundle.log || true
            echo "--- bundle logs ---"
            cat /tmp/bundle.log || true
            if [ -f "$BUNDLE" ]; then
              echo "bundle=$BUNDLE" >> $GITHUB_OUTPUT
            else
              echo "bundle=" >> $GITHUB_OUTPUT
            fi
          else
            echo "repo directory missing, cannot build bundle"
            echo "bundle=" >> $GITHUB_OUTPUT
          fi
          echo "bundle=$BUNDLE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release (best-effort)
        if: always()
        id: create_release
        continue-on-error: true
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            Release ${{ github.ref_name }} - Flatpak build generated by GitHub Actions
        env:
          # Prefer user-provided RELEASE_PAT (repo secret). Fallback to the workflow token.
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}

      - name: Ensure release exists and get upload URL
        id: release_info
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
        run: |
          set -euo pipefail
          TAG_NAME=${GITHUB_REF#refs/tags/}
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"
          # Try fetching release by tag
          resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API_URL/releases/tags/$TAG_NAME")
          release_id=$(echo "$resp" | jq -r '.id // empty') || true
          upload_url=$(echo "$resp" | jq -r '.upload_url // empty' | sed -e 's/{?name,label}//') || true
          if [ -z "${release_id:-}" ]; then
            echo "Release not found by tag, creating..."
            resp=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"$TAG_NAME\",\"prerelease\":true}" "$API_URL/releases")
            release_id=$(echo "$resp" | jq -r '.id')
            upload_url=$(echo "$resp" | jq -r '.upload_url' | sed -e 's/{?name,label}//')
          fi
          echo "release_id=$release_id" >> "$GITHUB_OUTPUT"
          echo "upload_url=$upload_url" >> "$GITHUB_OUTPUT"

      - name: Upload built Flatpak (or fallback) to Release
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
        run: |
          set -euo pipefail
          BUNDLE_PATH="${{ steps.create_bundle.outputs.bundle }}"
          if [ -n "$BUNDLE_PATH" ] && [ -f "$BUNDLE_PATH" ]; then
            file_to_upload="$BUNDLE_PATH"
          else
            file_to_upload="linux-armoury-0.5.0b0.flatpak"
          fi
          if [ ! -f "$file_to_upload" ]; then
            echo "File not found: $file_to_upload" >&2
            exit 1
          fi
          UPLOAD_URL="${{ steps.release_info.outputs.upload_url }}"
          echo "Uploading $file_to_upload to $UPLOAD_URL"
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/octet-stream" --data-binary @"$file_to_upload" "$UPLOAD_URL?name=$(basename "$file_to_upload")" | jq -r '.browser_download_url'

      # Fallback: if the built artifact is not available, attach the repo-provided
      # pre-built flatpak as an asset to the release so the tag has a usable artifact.
      - name: Upload repo-provided Flatpak (fallback)
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          files: linux-armoury-0.5.0b0.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
