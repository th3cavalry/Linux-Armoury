name: Build & publish Flatpak

on:
  push:
    tags:
      - 'v*'

jobs:
  build-flatpak:
    name: Build Flatpak and upload release asset
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends flatpak flatpak-builder jq

      - name: Ensure Flathub remote exists (user-level)
        run: |
          # Use the user-level remote to avoid requiring system permissions on the runner
          if ! flatpak --user remote-list 2>/dev/null | grep -q flathub; then
            flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          fi

      - name: Set up build directories
        run: |
          rm -rf build-dir repo
          mkdir -p build-dir repo

      - name: Build Flatpak repository
        continue-on-error: true
        run: |
          flatpak-builder --repo=repo --force-clean build-dir com.github.th3cavalry.linux-armoury.yml

      - name: Create Flatpak bundle
        if: always()
        id: create_bundle
        continue-on-error: true
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BUNDLE=linux-armoury-${TAG_NAME}.flatpak

          if [ ! -d repo ]; then
            echo "ERROR: repo directory not found"
            exit 1
          fi

          # Debug: Check repo structure
          echo "=== Repo structure ==="
          ls -la repo/ | head -20
          echo "=== Flatpak refs in repo ==="
          flatpak refs --repo=repo || echo "No refs found"

          # Attempt to create bundle
          echo "=== Attempting to create bundle: $BUNDLE ==="
          if flatpak build-bundle \
              --repo=repo \
              --force \
              "$BUNDLE" \
              com.github.th3cavalry.linux-armoury 2>&1; then
            echo "✓ Bundle created successfully"
            if [ -f "$BUNDLE" ]; then
              echo "output_file=$BUNDLE" >> $GITHUB_OUTPUT
            fi
          else
            echo "✗ Bundle creation failed, will use fallback"
          fi

      - name: Prepare Flatpak asset for release
        if: always()
        id: prepare_asset
        run: |
          # Check for built bundle
          BUILT_BUNDLE="${{ steps.create_bundle.outputs.output_file }}"
          FALLBACK_FILE="linux-armoury-0.5.0b0.flatpak"

          if [ -n "$BUILT_BUNDLE" ] && [ -f "$BUILT_BUNDLE" ]; then
            echo "asset=$BUILT_BUNDLE" >> $GITHUB_OUTPUT
            echo "Using built bundle: $BUILT_BUNDLE"
          elif [ -f "$FALLBACK_FILE" ]; then
            echo "asset=$FALLBACK_FILE" >> $GITHUB_OUTPUT
            echo "Using fallback: $FALLBACK_FILE"
          else
            echo "ERROR: No flatpak file available"
            exit 1
          fi

      - name: Create GitHub Release with Flatpak asset
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: ${{ steps.prepare_asset.outputs.asset }}
          body: |
            Release ${{ github.ref_name }} - Flatpak build generated by GitHub Actions
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT || github.token }}
